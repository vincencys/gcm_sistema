{% extends "_layout/base.html" %}
{% load core_extras %}
{% block title %}Ordem de ServiÃ§o{% endblock %}
{% block content %}
<!-- Header -->
<div class="mb-6 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
  <div class="px-4 py-3 flex items-center justify-between" style="background:#f1f5f9;border-bottom:1px solid #e5e7eb;">
    <div class="flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-violet-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6M9 8h6m2 9a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h6l4 4v10z"/></svg>
      <h1 class="text-xl font-bold text-slate-800">Ordem de ServiÃ§o</h1>
    </div>
  </div>
</div>

<form method="get" class="mb-4 flex items-center gap-2">
  <label class="text-sm text-slate-700">Ano</label>
  <select name="ano" class="border rounded px-2 py-1" onchange="this.form.submit()">
    {% for a in anos %}
      <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
    {% endfor %}
  </select>
</form>

<div class="grid md:grid-cols-3 lg:grid-cols-4 gap-4">
  {% for m in meses %}
  <div class="bg-white border rounded p-3">
    <div class="flex items-center justify-between mb-2">
      <div class="font-medium">{{ m.nome }}</div>
      <div class="text-xs text-slate-500">{{ m.num }}/{{ ano }}</div>
    </div>

    {% if m.anexos %}
      <div class="space-y-3">
        {% for item in m.anexos %}
          <div class="border rounded p-2">
            <div class="aspect-video bg-slate-100 rounded overflow-hidden flex items-center justify-center">
              {% if item.arquivo.url|is_image %}
                <img src="{{ item.arquivo.url }}" alt="OS {{ m.num }}/{{ ano }}" class="max-h-40 object-contain"/>
              {% elif item.arquivo.url|is_pdf %}
                <a href="{{ item.arquivo.url }}" target="_blank" class="flex items-center gap-2 text-slate-700">
                  <span>ðŸ“„</span> <span>PDF</span>
                </a>
              {% else %}
                <a href="{{ item.arquivo.url }}" target="_blank" class="text-slate-700 underline">Abrir arquivo</a>
              {% endif %}
            </div>
            <div class="mt-2 flex items-center gap-2">
              <a href="{{ item.arquivo.url }}" target="_blank" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm">Abrir</a>
              {% if can_manage %}
              <a href="{% url 'core:ordem_servico_remover' os_id=item.id %}" class="px-3 py-1 rounded bg-rose-600 text-white text-sm" onclick="return confirm('Remover anexo de {{ m.nome }} / {{ ano }}?');">Remover</a>
              {% endif %}
            </div>
            <div class="text-xs text-slate-500">Atualizado em {{ item.updated_at|date:"d/m/Y H:i" }}</div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-xs text-slate-500">Sem anexos.</p>
    {% endif %}

    {% if can_manage %}
    <form action="{% url 'core:ordem_servico_upload' %}" method="post" enctype="multipart/form-data" class="space-y-2 mt-3">
      {% csrf_token %}
      <input type="hidden" name="ano" value="{{ ano }}"/>
      <input type="hidden" name="mes" value="{{ m.num }}"/>
      <input type="file" name="arquivo" accept="image/*,.pdf" class="block w-full text-sm" required />
      <button type="submit" class="px-3 py-1 rounded bg-emerald-600 text-white text-sm">Inserir anexo</button>
    </form>
    {% endif %}
  </div>
  {% endfor %}
</div>
{% endblock %}
