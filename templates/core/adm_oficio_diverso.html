{% extends '_layout/base.html' %}
{% block title %}Administração - Ofícios Diversos{% endblock %}
{% block content %}
<div class="max-w-6xl mx-auto">
  <!-- Header -->
  <div class="mb-6 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
    <div class="px-4 py-3 flex items-center justify-between" style="background:#f1f5f9;border-bottom:1px solid #e5e7eb;">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
        <h1 class="text-xl font-bold text-slate-800">Ofícios Diversos</h1>
      </div>
    </div>
  </div>

  <!-- Filtro de Ano -->
  <form method="get" class="mb-6 flex items-center gap-3">
    <label class="text-sm font-medium text-slate-700">Ano:</label>
    <select name="ano" class="px-3 py-2 rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-indigo-200" onchange="this.form.submit()">
      {% for a in anos %}
        <option value="{{ a }}" {% if a == ano %}selected{% endif %}>{{ a }}</option>
      {% endfor %}
    </select>
  </form>

  <!-- Lista de Meses -->
  <div class="space-y-6">
    {% for mes in meses %}
    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
      <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between">
        <h2 class="text-lg font-semibold text-slate-700">{{ mes.nome }} {{ ano }}</h2>
        {% if can_manage %}
        <button onclick="document.getElementById('upload-form-{{ mes.num }}').classList.toggle('hidden')" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
          + Adicionar Anexo
        </button>
        {% endif %}
      </div>

      {% if can_manage %}
      <!-- Formulário de Upload (oculto por padrão) -->
      <form id="upload-form-{{ mes.num }}" method="post" action="{% url 'core:oficio_diverso_upload' %}" enctype="multipart/form-data" class="hidden p-4 bg-blue-50 border-b border-slate-200">
        {% csrf_token %}
        <input type="hidden" name="ano" value="{{ ano }}">
        <input type="hidden" name="mes" value="{{ mes.num }}">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Descrição</label>
            <input type="text" name="descricao" required class="w-full px-3 py-2 rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-200" placeholder="Descrição do ofício">
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Arquivo PDF</label>
            <input type="file" name="arquivo" accept=".pdf" required class="w-full px-3 py-2 rounded border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-200">
          </div>
          <div class="flex items-end">
            <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Enviar</button>
          </div>
        </div>
      </form>
      {% endif %}

      <!-- Lista de Anexos do Mês -->
      <div class="p-4">
        {% if mes.anexos %}
        <div class="space-y-2">
          {% for anexo in mes.anexos %}
          <div class="flex items-center justify-between p-3 bg-slate-50 rounded border border-slate-200">
            <div class="flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
              <div>
                <p class="font-medium text-slate-800">{{ anexo.descricao }}</p>
                <p class="text-xs text-slate-500">Enviado em {{ anexo.created_at|date:'d/m/Y H:i' }}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <a href="{{ anexo.arquivo.url }}" target="_blank" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                Visualizar
              </a>
              {% if can_manage %}
              <form method="post" action="{% url 'core:oficio_diverso_remover' anexo.id %}" onsubmit="return confirm('Deseja realmente remover este anexo?')">
                {% csrf_token %}
                <button type="submit" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                  Remover
                </button>
              </form>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="text-slate-500 text-center py-6">Nenhum anexo cadastrado para este mês</p>
        {% endif %}
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
