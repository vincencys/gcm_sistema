{% extends "_layout/base.html" %}
{% block title %}Banco de Horas{% endblock %}
{% block content %}
<!-- Header -->
<div class="mb-6 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
	<div class="px-4 py-3 flex items-center justify-between" style="background:#f1f5f9;border-bottom:1px solid #e5e7eb;">
		<div class="flex items-center gap-2">
			<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
			<h1 class="text-xl font-bold text-slate-800">Banco de Horas</h1>
		</div>
	</div>
</div>

<form method="get" class="mb-4 flex gap-2 items-center">
	<input type="text" name="q" value="{{ q }}" placeholder="Buscar por nome, usuário ou matrícula" class="border rounded px-3 py-2 w-72" />
	<button class="bg-blue-600 text-white px-4 py-2 rounded">Buscar</button>
	{% if q %}
		<a href="?" class="text-sm text-slate-600 underline ml-2">Limpar</a>
	{% endif %}
	{% if not can_manage %}
		<span class="ml-auto text-xs text-slate-500">Somente visualização</span>
	{% endif %}
	{% csrf_token %}
	<input type="hidden" id="csrf-token" value="{{ csrf_token }}" />
	<input type="hidden" id="ajuste-url" value="{% url 'core:banco_de_horas_ajustar' %}" />
{% comment %} encerramento do form no final para não englobar a tabela {% endcomment %}
</form>

<div class="overflow-x-auto border rounded">
	<table class="min-w-full text-sm border-separate border-spacing-0">
		<thead>
			<tr class="bg-slate-100 text-left border-b border-gray-200">
				<th class="px-3 py-2 border-r border-gray-300 last:border-r-0">GCM</th>
				<th class="px-3 py-2 border-r border-gray-300 last:border-r-0">Matrícula</th>
				<th class="px-3 py-2 border-r border-gray-300 last:border-r-0">Horas Positivas</th>
				<th class="px-3 py-2 border-r border-gray-300 last:border-r-0">Horas Devidas</th>
				{% if can_manage %}
				<th class="px-3 py-2 text-center border-r border-gray-300 last:border-r-0">Ações</th>
				{% endif %}
			</tr>
		</thead>
		<tbody>
			{% if linhas %}
				{% for r in linhas %}
					<tr class="hover:bg-slate-50" data-user="{{ r.user_id }}">
						<td class="px-3 py-2 border-t border-gray-200 border-r border-gray-300 last:border-r-0">{{ r.nome }}</td>
						<td class="px-3 py-2 border-t border-gray-200 border-r border-gray-300 last:border-r-0">{{ r.matricula }}</td>
						<td class="px-3 py-2 font-mono border-t border-gray-200 border-r border-gray-300 last:border-r-0" data-col="positivas">{{ r.positivas }}</td>
						<td class="px-3 py-2 font-mono border-t border-gray-200 border-r border-gray-300 last:border-r-0" data-col="devidas">{{ r.devidas }}</td>
						{% if can_manage %}
						<td class="px-3 py-2 text-center border-t border-gray-200 border-r border-gray-300 last:border-r-0">
							<div class="inline-flex gap-2">
								<button type="button" class="bg-emerald-600 text-white px-3 py-1 rounded text-xs" onclick="ajustarBancoHoras({{ r.user_id }}, &quot;add&quot;)">Adicionar</button>
								<button type="button" class="bg-rose-600 text-white px-3 py-1 rounded text-xs" onclick="ajustarBancoHoras({{ r.user_id }}, &quot;remove&quot;)">Remover</button>
								<a class="px-3 py-1 rounded text-xs border hover:bg-slate-50" href="{% url 'core:banco_de_horas_lancamentos' r.user_id %}">Lançamentos</a>
							</div>
						</td>
						{% endif %}
					</tr>
				{% endfor %}
			{% else %}
				<tr><td colspan="5" class="px-3 py-4 text-slate-500">Nenhum usuário encontrado.</td></tr>
			{% endif %}
		</tbody>
	</table>
	</div>

<div class="mt-3">
	{% include '_partials/pagination.html' with page_obj=page_obj extra_query=extra_query %}
  </div>

<script>
function getCsrfToken() {
	const el = document.getElementById('csrf-token');
	return el ? el.value : '';
}
async function ajustarBancoHoras(userId, action) {
	try {
		const hhmm = prompt('Informe horas (HH:MM)');
		if (!hhmm) return;
		const motivo = prompt('Motivo (opcional)') || '';
		const url = document.getElementById('ajuste-url').value;
		const resp = await fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCsrfToken(),
				'Accept': 'application/json'
			},
			body: JSON.stringify({ user_id: userId, action, hhmm, motivo })
		});
		const data = await resp.json();
		if (!resp.ok || !data.ok) {
			alert(data.error || 'Falha ao ajustar.');
			return;
		}
		const tr = document.querySelector(`tr[data-user="${userId}"]`);
		if (tr) {
			const pos = tr.querySelector('[data-col="positivas"]');
			const dev = tr.querySelector('[data-col="devidas"]');
			if (pos) pos.textContent = data.positivas;
			if (dev) dev.textContent = data.devidas;
		}
	} catch (e) {
		alert('Erro: ' + e);
	}
}
</script>

{% endblock %}
