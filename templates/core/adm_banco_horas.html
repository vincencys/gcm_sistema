{% extends "_layout/base.html" %}
{% block title %}Banco de Horas{% endblock %}
{% block content %}
<div class="container max-w-screen-2xl mx-auto p-3 md:p-6">
	<!-- Header -->
	<div class="mb-6 bg-white border-2 border-sky-600 rounded-xl shadow-lg overflow-hidden">
		<div class="px-6 py-5 flex items-center justify-between">
			<div class="flex items-center gap-3">
				<div class="p-3 bg-sky-100 rounded-lg">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-sky-700" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
				</div>
				<div>
					<h1 class="text-3xl font-bold text-gray-900">Banco de Horas</h1>
					<p class="text-sm text-slate-600">Gerenciamento de horas dos GCMs</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Busca -->
	<div class="mb-6 bg-white border border-slate-200 rounded-xl shadow-sm p-4">
		<form method="get" class="flex flex-col md:flex-row gap-3 items-stretch md:items-center">
			<div class="flex-1">
				<input type="text" name="q" value="{{ q }}" placeholder="Buscar por nome, usuário ou matrícula" class="w-full border border-slate-300 rounded-lg px-4 py-2.5 text-sm focus:ring-2 focus:ring-sky-500 focus:border-sky-500" />
			</div>
			<button class="px-6 py-2.5 bg-sky-600 text-white font-medium rounded-lg hover:bg-sky-700 transition-colors shadow-sm">
				Buscar
			</button>
			{% if q %}
				<a href="?" class="px-6 py-2.5 bg-slate-100 text-slate-700 font-medium rounded-lg hover:bg-slate-200 transition-colors text-center">Limpar</a>
			{% endif %}
			{% if not can_manage %}
				<span class="px-4 py-2.5 text-sm text-slate-500 bg-slate-50 rounded-lg">Somente visualização</span>
			{% endif %}
			{% csrf_token %}
			<input type="hidden" id="csrf-token" value="{{ csrf_token }}" />
			<input type="hidden" id="ajuste-url" value="{% url 'core:banco_de_horas_ajustar' %}" />
		</form>
	</div>

	<!-- Tabela -->
	<div class="bg-white border border-slate-200 rounded-xl shadow-sm overflow-hidden">
		<div class="px-5 py-3 bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
			<h2 class="font-semibold text-base text-slate-800 flex items-center gap-2">
				<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-sky-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
				Registros de Banco de Horas
			</h2>
		</div>
		<div class="overflow-x-auto">
			<table class="min-w-full text-sm border-collapse">
				<thead>
					<tr class="bg-gradient-to-r from-sky-50 to-sky-100 text-left border-b-2 border-sky-200">
						<th class="px-4 py-3 font-bold text-sky-900 border-r border-slate-200">GCM</th>
						<th class="px-4 py-3 font-bold text-sky-900 border-r border-slate-200">Matrícula</th>
						<th class="px-4 py-3 font-bold text-sky-900 border-r border-slate-200">Horas Positivas</th>
						<th class="px-4 py-3 font-bold text-sky-900 border-r border-slate-200">Horas Devidas</th>
						{% if can_manage %}
						<th class="px-4 py-3 text-center font-bold text-sky-900">Ações</th>
						{% endif %}
					</tr>
				</thead>
				<tbody>
					{% if linhas %}
						{% for r in linhas %}
							<tr class="hover:bg-sky-50 transition-colors border-b border-slate-200" data-user="{{ r.user_id }}">
								<td class="px-4 py-3 font-medium text-slate-900 border-r border-slate-200">{{ r.nome }}</td>
								<td class="px-4 py-3 text-slate-600 border-r border-slate-200">{{ r.matricula }}</td>
								<td class="px-4 py-3 font-mono font-semibold text-emerald-700 bg-emerald-50 border-r border-slate-200" data-col="positivas">{{ r.positivas }}</td>
								<td class="px-4 py-3 font-mono font-semibold text-rose-700 bg-rose-50 border-r border-slate-200" data-col="devidas">{{ r.devidas }}</td>
								{% if can_manage %}
								<td class="px-4 py-3 text-center">
									<div class="inline-flex gap-2 flex-wrap justify-center">
										<button type="button" class="inline-flex items-center gap-1 bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors shadow-sm" onclick="ajustarBancoHoras({{ r.user_id }}, &quot;add&quot;)">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
											Adicionar
										</button>
										<button type="button" class="inline-flex items-center gap-1 bg-rose-600 hover:bg-rose-700 text-white px-3 py-1.5 rounded-lg text-xs font-medium transition-colors shadow-sm" onclick="ajustarBancoHoras({{ r.user_id }}, &quot;remove&quot;)">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"/></svg>
											Remover
										</button>
										<a class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg text-xs font-medium border border-slate-300 hover:bg-slate-50 transition-colors" href="{% url 'core:banco_de_horas_lancamentos' r.user_id %}">
											<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
											Lançamentos
										</a>
									</div>
								</td>
								{% endif %}
							</tr>
						{% endfor %}
					{% else %}
						<tr><td colspan="5" class="px-4 py-8 text-center text-slate-500">Nenhum usuário encontrado.</td></tr>
					{% endif %}
				</tbody>
			</table>
		</div>
	</div>

	<div class="mt-6">
		{% include '_partials/pagination.html' with page_obj=page_obj extra_query=extra_query %}
	</div>
</div>

<script>
function getCsrfToken() {
	const el = document.getElementById('csrf-token');
	return el ? el.value : '';
}
async function ajustarBancoHoras(userId, action) {
	try {
		const hhmm = prompt('Informe horas (HH:MM)');
		if (!hhmm) return;
		const motivo = prompt('Motivo (opcional)') || '';
		const url = document.getElementById('ajuste-url').value;
		const resp = await fetch(url, {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
				'X-CSRFToken': getCsrfToken(),
				'Accept': 'application/json'
			},
			body: JSON.stringify({ user_id: userId, action, hhmm, motivo })
		});
		const data = await resp.json();
		if (!resp.ok || !data.ok) {
			alert(data.error || 'Falha ao ajustar.');
			return;
		}
		const tr = document.querySelector(`tr[data-user="${userId}"]`);
		if (tr) {
			const pos = tr.querySelector('[data-col="positivas"]');
			const dev = tr.querySelector('[data-col="devidas"]');
			if (pos) pos.textContent = data.positivas;
			if (dev) dev.textContent = data.devidas;
		}
	} catch (e) {
		alert('Erro: ' + e);
	}
}
</script>

{% endblock %}
