{% extends "base.html" %}
{% load viaturas_extras %}

{% block content %}
<h1 class="text-xl font-semibold mb-2">Avarias da Viatura {{ viatura.prefixo }}</h1>
<p class="text-sm text-slate-600 mb-4">Data: {{ data|date:"d/m/Y" }} · Registros: {{ registros }} checklist(s)</p>

<div class="bg-white border rounded-lg p-4">
  {% if page_obj and page_obj.paginator.count %}
    <form id="form-resolver" method="post" action="{% url 'viaturas:resolver_avarias' viatura.id %}">
      {% csrf_token %}
      <div class="mb-3 flex items-center justify-between">
        <div class="text-sm text-slate-600">Selecionados: <span id="cnt">0</span></div>
        <div class="flex gap-2">
          <label class="text-sm"><input type="checkbox" id="chk-all" class="mr-1"> Selecionar todos</label>
          <button type="submit" id="btn-resolver" class="bg-emerald-600 text-white px-3 py-1 rounded disabled:opacity-50" disabled>Resolver selecionadas</button>
        </div>
      </div>
      <ul class="ml-1 space-y-1">
        {% for it in page_obj.object_list %}
          <li class="flex items-start gap-2">
            <input type="checkbox" class="chk-row mt-1" name="itens" value="{{ it }}">
            <div class="flex-1">
              <span>{{ it }}</span>
              {% if anexos_map and it in anexos_map %}
                <div class="mt-2 flex flex-wrap gap-2">
                  {% for anexo in anexos_map|get_item:it %}
                    <div class="relative group">
                      <a href="{{ anexo.arquivo.url }}" target="_blank" class="block">
                        <img src="{{ anexo.arquivo.url }}" alt="Anexo" 
                             class="h-20 w-20 object-cover rounded border hover:opacity-80 transition-opacity" />
                      </a>
                      {% if anexo.descricao %}
                        <div class="text-xs text-slate-600 mt-1">{{ anexo.descricao }}</div>
                      {% endif %}
                    </div>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          </li>
        {% endfor %}
      </ul>
    </form>
  {% else %}
    <p class="opacity-70">Nenhuma avaria pendente registrada para esta viatura.</p>
  {% endif %}
</div>

{# Histórico de registros do dia #}
{% if logs_dia %}
<div class="mt-4 bg-white border rounded-lg p-4">
  <h2 class="font-semibold mb-2">Registros do dia</h2>
  <ul class="text-sm list-disc list-inside space-y-1">
    {% for log in logs_dia %}
      <li>
        {{ log.criado_em|date:"H:i" }} — 
        <strong>{{ log.usuario.get_full_name|default:log.usuario.username }}</strong> marcou: 
        {{ log.itens|join:", " }}
      </li>
    {% endfor %}
  </ul>
  {% if not logs_dia %}
    <p class="text-sm text-slate-500">Sem registros hoje.</p>
  {% endif %}
  <p class="text-[11px] text-slate-500 mt-2">Este histórico permanece salvo para auditoria, mesmo após resolver as avarias.</p>
  
</div>
{% endif %}

{# Filtros e Resoluções (dia atual por padrão) #}
<div class="mt-4 bg-white border rounded-lg p-4">
  <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
    <h2 class="font-semibold">{% if resolvidos_is_expanded or data_de or data_ate %}Resoluções{% else %}Resoluções do dia{% endif %}</h2>
    <form method="get" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2">
      {% if viaturas_all %}
        <label class="text-sm">
          <span class="block text-slate-600 mb-1">Viatura</span>
          <select name="viatura" class="input w-full">
            {% for vopt in viaturas_all %}
              <option value="{{ vopt.id }}" {% if vopt.id == viatura.id %}selected{% endif %}>{{ vopt.prefixo }}</option>
            {% endfor %}
          </select>
        </label>
      {% endif %}
      <label class="text-sm">
        <span class="block text-slate-600 mb-1">De</span>
        <input type="date" name="data_de" value="{{ data_de }}" class="input w-full"/>
      </label>
      <label class="text-sm">
        <span class="block text-slate-600 mb-1">Até</span>
        <input type="date" name="data_ate" value="{{ data_ate }}" class="input w-full"/>
      </label>
      <div class="flex items-end gap-2">
        <button class="btn">Filtrar</button>
        <a href="{% url 'viaturas:avarias' viatura.id %}" class="btn btn-ghost">Limpar</a>
      </div>
    </form>
  </div>

  {% if resolvidos_is_expanded %}
    {% with lista=resolvidos %}
      {% if lista %}
        <ul class="mt-3 text-sm list-disc list-inside space-y-1">
          {% for r in lista %}
            <li>
              {{ r.criado_em|date:"d/m H:i" }} — 
              <strong>{{ r.usuario.get_full_name|default:r.usuario.username }}</strong> resolveu: 
              {{ r.itens|join:", " }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-slate-500 mt-2">Sem resoluções para o período selecionado.</p>
      {% endif %}
    {% endwith %}
  {% else %}
    {% with lista=resolvidos_dia %}
      {% if lista %}
        <ul class="mt-3 text-sm list-disc list-inside space-y-1">
          {% for r in lista %}
            <li>
              {{ r.criado_em|date:"d/m H:i" }} — 
              <strong>{{ r.usuario.get_full_name|default:r.usuario.username }}</strong> resolveu: 
              {{ r.itens|join:", " }}
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-sm text-slate-500 mt-2">Sem resoluções para o dia.</p>
      {% endif %}
    {% endwith %}
  {% endif %}

  {% if not resolvidos_is_expanded and resolvidos_dia and resolvidos_dia|length > 0 %}
    <div class="mt-3">
      <a href="?mais=1" class="text-sm text-blue-600 hover:underline">Mostrar mais (últimas 20)</a>
    </div>
  {% endif %}
</div>

{% if page_obj and page_obj.paginator.num_pages > 1 %}
  <div class="mt-3 flex items-center justify-between text-sm">
    <div>
      Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
      ({{ page_obj.start_index }}-{{ page_obj.end_index }} de {{ page_obj.paginator.count }})
    </div>
    <div class="flex gap-1">
      {% if page_obj.has_previous %}
        <a class="px-2 py-1 border rounded hover:bg-slate-50" href="?page=1">«</a>
        <a class="px-2 py-1 border rounded hover:bg-slate-50" href="?page={{ page_obj.previous_page_number }}">‹</a>
      {% else %}
        <span class="px-2 py-1 border rounded opacity-40 select-none">«</span>
        <span class="px-2 py-1 border rounded opacity-40 select-none">‹</span>
      {% endif %}
      <span class="px-2 py-1 border rounded bg-slate-50 select-none">Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}</span>
      {% if page_obj.has_next %}
        <a class="px-2 py-1 border rounded hover:bg-slate-50" href="?page={{ page_obj.next_page_number }}">›</a>
        <a class="px-2 py-1 border rounded hover:bg-slate-50" href="?page={{ page_obj.paginator.num_pages }}">»</a>
      {% else %}
        <span class="px-2 py-1 border rounded opacity-40 select-none">›</span>
        <span class="px-2 py-1 border rounded opacity-40 select-none">»</span>
      {% endif %}
    </div>
  </div>
{% endif %}

<div class="mt-4 flex gap-2">
  <a href="{% url 'viaturas:lista' %}?q={{ viatura.prefixo }}" class="btn">Voltar para Viaturas</a>
</div>

<script>
(function(){
  const all = document.getElementById('chk-all');
  const rows = Array.from(document.querySelectorAll('.chk-row'));
  const btn = document.getElementById('btn-resolver');
  const cnt = document.getElementById('cnt');
  const form = document.getElementById('form-resolver');
  function update(){
    const n = rows.filter(r=>r.checked).length;
    cnt.textContent = n;
    btn.disabled = n===0;
  }
  if(all){ all.addEventListener('change', ()=>{ rows.forEach(r=>r.checked = all.checked); update(); }); }
  rows.forEach(r=>r.addEventListener('change', update));
  form.addEventListener('submit', function(e){
    const n = rows.filter(r=>r.checked).length;
    if(n===0){ e.preventDefault(); return; }
    if(!confirm(`Resolver ${n} avaria(s) selecionada(s)?`)){
      e.preventDefault();
    }
  });
})();
</script>
{% endblock %}
