{% extends "base.html" %}
{% block title %}Lista de Envolvidos{% endblock %}
{% block content %}
<div class="container mx-auto mt-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
        <h2 class="text-2xl font-bold text-indigo-800">Envolvidos</h2>
        <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
            {% if bo %}
            <a href="{% url 'bogcmi:editar' bo.pk %}" class="px-4 py-2 rounded bg-slate-600 text-white text-sm font-semibold shadow w-full sm:w-auto text-center">Voltar</a>
            {% else %}
            <a href="{% url 'bogcmi:novo' %}" class="px-4 py-2 rounded bg-slate-600 text-white text-sm font-semibold shadow w-full sm:w-auto text-center">Voltar</a>
            {% endif %}
            <a href="{% url 'bogcmi:envolvido_form' %}{% if bo %}?bo={{ bo.pk }}{% endif %}" class="px-4 py-2 rounded bg-indigo-600 text-white text-sm font-semibold shadow w-full sm:w-auto text-center">Novo</a>
            <a href="{% url 'bogcmi:envolvido_form_offline' %}?bo={{ bo.pk }}" target="_blank" class="px-4 py-2 rounded bg-amber-600 text-white text-sm font-semibold shadow w-full sm:w-auto text-center">Baixar Formulário Offline</a>
            <button id="btn-importar-offline" class="px-4 py-2 rounded bg-green-600 text-white text-sm font-semibold shadow w-full sm:w-auto" type="button">Importar Offline</button>
            <button id="btn-processar-lote" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold shadow w-full sm:w-auto" type="button">Processar Itens Salvos</button>
        </div>
    </div>
    {# Mobile: cards #}
    <div class="md:hidden space-y-3">
        {% for envolvido in envolvidos %}
        <div class="bg-white border rounded-xl p-3 shadow-sm">
            <div class="font-semibold truncate">{{ envolvido.nome }}</div>
            <div class="mt-1 text-xs text-slate-600">Versão: {{ envolvido.dados_adicionais|default:"-" }}</div>
            <div class="mt-2 text-sm">
                <span class="text-slate-500">Assinatura:</span>
                {% if envolvido.assinatura %}
                    <img src="{{ envolvido.assinatura.url }}" alt="Assinatura" class="max-h-10 inline-block ml-2 align-middle">
                {% else %}
                    <span class="text-slate-400">-</span>
                {% endif %}
            </div>
            <div class="mt-3 grid grid-cols-2 gap-2">
                <a href="{% url 'bogcmi:envolvido_editar' envolvido.pk %}" class="inline-flex items-center justify-center h-9 px-3 border rounded bg-blue-50 text-blue-700 hover:bg-blue-100">Editar</a>
                <button type="button" class="inline-flex items-center justify-center h-9 px-3 border rounded bg-rose-50 text-rose-700 hover:bg-rose-100 btn-excluir-envolvido" data-id="{{ envolvido.pk }}">Excluir</button>
            </div>
        </div>
        {% empty %}
          <div class="text-center text-slate-500">Nenhum envolvido cadastrado.</div>
        {% endfor %}
    </div>

    {# Desktop: tabela #}
    <div class="hidden md:block overflow-x-auto">
    <table class="min-w-full bg-white border rounded-xl shadow">
        <thead class="bg-indigo-50">
            <tr>
                <th class="px-4 py-2 border-b text-indigo-700 text-left">Nome Completo</th>
                <th class="px-4 py-2 border-b text-indigo-700 text-left">Versão</th>
                <th class="px-4 py-2 border-b text-indigo-700 text-left">Assinatura</th>
                <th class="px-4 py-2 border-b text-indigo-700 text-left">Ações</th>
            </tr>
        </thead>
        <tbody>
            {% for envolvido in envolvidos %}
            <tr class="hover:bg-indigo-50">
                <td class="px-4 py-2 border-b">{{ envolvido.nome }}</td>
                <td class="px-4 py-2 border-b">{{ envolvido.dados_adicionais|default:"-" }}</td>
                <td class="px-4 py-2 border-b">
                    {% if envolvido.assinatura %}
                        <img src="{{ envolvido.assinatura.url }}" alt="Assinatura" class="max-h-10">
                    {% else %}<span class="text-slate-500">-</span>{% endif %}
                </td>
                <td class="px-4 py-2 border-b">
                    <a href="{% url 'bogcmi:envolvido_editar' envolvido.pk %}" class="px-2 py-1 rounded bg-blue-600 text-white">Editar</a>
                    <button type="button" class="px-2 py-1 rounded bg-red-600 text-white ml-2 btn-excluir-envolvido" data-id="{{ envolvido.pk }}">Excluir</button>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="4" class="px-4 py-2 text-center text-slate-500">Nenhum envolvido cadastrado.</td></tr>
            {% endfor %}
        </tbody>
    </table>
    </div>
    <!-- Modal Importar Offline -->
    <div id="modal-import-offline" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-xl p-5 flex flex-col gap-4">
            <div class="flex items-center justify-between">
                <h3 class="text-lg font-bold text-indigo-700">Importar Envolvido Offline</h3>
                <button type="button" id="imp-fechar" class="text-slate-500 hover:text-slate-800 font-bold">✕</button>
            </div>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto">
                <div>
                    <label class="block text-xs font-semibold text-slate-600 mb-1">Carregar Arquivo JSON Exportado</label>
                    <input type="file" id="imp-arquivo" accept="application/json" class="block w-full text-sm border rounded px-2 py-1" />
                </div>
                <div>
                    <p class="text-xs text-slate-600 mb-1">Itens salvos localmente neste navegador (localStorage):</p>
                    <table class="w-full text-xs border rounded overflow-hidden">
                        <thead class="bg-slate-100 text-slate-700">
                            <tr><th class="p-1 text-left">Nome</th><th class="p-1 text-left">Condição</th><th class="p-1">Quando</th><th class="p-1">Ação</th></tr>
                        </thead>
                        <tbody id="imp-itens-local" class="divide-y"></tbody>
                    </table>
                </div>
                <div id="imp-msg" class="text-xs font-semibold"></div>
            </div>
            <div class="flex justify-end gap-2 pt-2 border-t">
                <button id="imp-salvar-arquivo" type="button" class="px-4 py-2 rounded bg-green-600 text-white text-sm font-semibold disabled:opacity-50">Importar Arquivo</button>
                <button id="imp-processar-selecionados" type="button" class="px-4 py-2 rounded bg-blue-600 text-white text-sm font-semibold">Importar Selecionados</button>
            </div>
        </div>
    </div>
</div>
<script>
// --- Importação Offline de Envolvidos ---
(function(){
    const STORAGE_KEY = 'bogcmi-offline-envolvidos:bo:{{ bo.id }}';
    const modal = document.getElementById('modal-import-offline');
    const btnAbrir = document.getElementById('btn-importar-offline');
    const btnFechar = document.getElementById('imp-fechar');
    const arquivoInput = document.getElementById('imp-arquivo');
    const btnImportArquivo = document.getElementById('imp-salvar-arquivo');
    const btnImportSelecionados = document.getElementById('imp-processar-selecionados');
    const tbodyLocal = document.getElementById('imp-itens-local');
    const msg = document.getElementById('imp-msg');
    const btnProcessarLote = document.getElementById('btn-processar-lote');
    if(!modal) return;

    function abrir(){ modal.classList.remove('hidden'); modal.classList.add('flex'); carregarListaLocal(); }
    function fechar(){ modal.classList.add('hidden'); modal.classList.remove('flex'); msg.textContent=''; }
    btnAbrir && btnAbrir.addEventListener('click', abrir);
    btnFechar && btnFechar.addEventListener('click', fechar);
    modal.addEventListener('click', e=>{ if(e.target===modal) fechar(); });

    function carregarListaLocal(){
        tbodyLocal.innerHTML='';
        let lista=[]; try{ lista=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){}
        if(!lista.length){ tbodyLocal.innerHTML='<tr><td colspan="4" class="p-2 text-center text-slate-400">Nenhum item salvo.</td></tr>'; return; }
        lista.forEach((it,idx)=>{
            const tr=document.createElement('tr'); tr.className='hover:bg-indigo-50';
            const dt = it._ts? new Date(it._ts): null;
            tr.innerHTML=`<td class='p-1'>${(it.nome||'-')}</td><td class='p-1'>${(it.condicao||'-')}</td><td class='p-1 text-slate-500'>${dt?dt.toLocaleString():''}</td><td class='p-1'><label class='inline-flex items-center gap-1'><input type='checkbox' data-idx='${idx}' class='imp-sel'> <span>Sel.</span></label></td>`;
            tbodyLocal.appendChild(tr);
        });
    }

    function coletarSelecionados(){
        let lista=[]; try{ lista=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){}
        const out=[];
        tbodyLocal.querySelectorAll('.imp-sel:checked').forEach(chk=>{
            const i=parseInt(chk.getAttribute('data-idx')); if(!isNaN(i) && lista[i]) out.push(lista[i]);
        });
        return out;
    }

    async function enviar(envolvidos){
        if(!envolvidos.length){ msg.textContent='Nenhum item selecionado.'; msg.className='text-xs font-semibold text-amber-600'; return; }
        msg.textContent='Enviando '+envolvidos.length+'...'; msg.className='text-xs font-semibold text-indigo-600';
        try {
            const formData = new FormData();
            formData.append('bo', '{{ bo.id }}');
            formData.append('payload', JSON.stringify(envolvidos));
            const resp = await fetch('{% url "bogcmi:envolvido_import_offline" %}', {method:'POST', headers:{'X-CSRFToken':getCsrf()}, body: formData});
            if(!resp.ok) throw new Error('HTTP '+resp.status);
            const data = await resp.json();
            msg.textContent='Importados: '+data.importados+' | Ignorados: '+data.ignorados; msg.className='text-xs font-semibold text-green-600';
            setTimeout(()=>{ window.location.reload(); }, 800);
        } catch(e){ msg.textContent='Falha: '+e.message; msg.className='text-xs font-semibold text-rose-600'; }
    }

    btnImportSelecionados && btnImportSelecionados.addEventListener('click', ()=>{
        const sel = coletarSelecionados(); enviar(sel);
    });

    btnImportArquivo && btnImportArquivo.addEventListener('click', ()=>{
        const f = arquivoInput.files && arquivoInput.files[0]; if(!f){ msg.textContent='Selecione um arquivo.'; msg.className='text-xs font-semibold text-amber-600'; return; }
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const json = JSON.parse(e.target.result);
                const arr = Array.isArray(json) ? json : [json];
                enviar(arr);
            } catch(err){ msg.textContent='JSON inválido.'; msg.className='text-xs font-semibold text-rose-600'; }
        };
        reader.readAsText(f);
    });

    btnProcessarLote && btnProcessarLote.addEventListener('click', ()=>{
        let lista=[]; try{ lista=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]'); }catch(e){}
        if(!lista.length){ alert('Nenhum item salvo offline para este BO.'); return; }
        if(!confirm('Enviar todos os '+lista.length+' itens offline salvos deste BO?')) return;
        enviar(lista);
    });

    function getCsrf(){ const m=document.cookie.match(/csrftoken=([^;]+)/); return m?m[1]:''; }
})();

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('btn-excluir-envolvido')) {
        const envolvidoId = e.target.getAttribute('data-id');
        if (confirm('Tem certeza que deseja excluir este envolvido? Essa ação não pode ser desfeita.')) {
            const qs = '{% if bo %}?bo={{ bo.pk }}{% endif %}';
            window.location.href = `/bogcmi/envolvido/${envolvidoId}/excluir/${qs}`;
        }
    }
});
</script>
{% endblock %}
