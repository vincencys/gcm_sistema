{% extends "_layout/base.html" %}
{% block title %}Despachar Ocorr√™ncia{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <div class="flex items-center gap-3 mb-6">
    <a href="{% url 'cecom:painel' %}" class="text-blue-600 hover:underline">‚Üê Voltar ao Painel</a>
    <h1 class="text-xl font-semibold">Despachar Nova Ocorr√™ncia</h1>
  </div>

  <form method="post" class="bg-white border rounded-lg p-6 space-y-4">
    {% csrf_token %}
    
    <!-- Viatura -->
    <div>
      <label class="block text-sm font-medium mb-1">Viatura *</label>
      {{ form.viatura }}
      {% if form.viatura.errors %}
        <p class="text-red-600 text-sm mt-1">{{ form.viatura.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- C√≥digo/Natureza da Ocorr√™ncia -->
    <div>
      <label class="block text-sm font-medium mb-1">Tipo de Ocorr√™ncia</label>
      {{ form.codigo }}
      {% if form.codigo.errors %}
        <p class="text-red-600 text-sm mt-1">{{ form.codigo.errors.0 }}</p>
      {% endif %}
      <p class="text-xs text-slate-500 mt-1">Formato: C√ìDIGO ‚Äî Descri√ß√£o. Opcional.</p>
    </div>

    <!-- Endere√ßo com Mapa -->
    <div>
      <label class="block text-sm font-medium mb-1">Endere√ßo da Ocorr√™ncia *</label>
      {{ form.endereco }}
      <button type="button" id="buscar-endereco" class="mt-2 px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
        Localizar no Mapa
      </button>
      {% if form.endereco.errors %}
        <p class="text-red-600 text-sm mt-1">{{ form.endereco.errors.0 }}</p>
      {% endif %}
      
      <!-- Mapa -->
      <div id="map" class="mt-3 h-64 border rounded" style="display: none;"></div>
      {{ form.latitude }}
      {{ form.longitude }}
    </div>

    <!-- Dados do Solicitante -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium mb-1">Nome do Solicitante</label>
        {{ form.nome_solicitante }}
        {% if form.nome_solicitante.errors %}
          <p class="text-red-600 text-sm mt-1">{{ form.nome_solicitante.errors.0 }}</p>
        {% endif %}
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Telefone</label>
        {{ form.telefone_solicitante }}
        {% if form.telefone_solicitante.errors %}
          <p class="text-red-600 text-sm mt-1">{{ form.telefone_solicitante.errors.0 }}</p>
        {% endif %}
      </div>
    </div>

    <!-- Descri√ß√£o -->
    <div>
      <label class="block text-sm font-medium mb-1">Descri√ß√£o da Ocorr√™ncia *</label>
      {{ form.descricao }}
      {% if form.descricao.errors %}
        <p class="text-red-600 text-sm mt-1">{{ form.descricao.errors.0 }}</p>
      {% endif %}
    </div>

    <!-- Bot√µes -->
    <div class="flex gap-3 pt-4">
      <button type="submit" class="px-6 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium">
        üö® Despachar para Viatura
      </button>
      <a href="{% url 'cecom:painel' %}" class="px-6 py-2 border rounded hover:bg-slate-50">
        Cancelar
      </a>
    </div>
  </form>
</div>

<!-- Script para Mapa -->
<script>
let map;
let marker;

document.getElementById('buscar-endereco').addEventListener('click', function() {
  const endereco = document.getElementById('endereco-input').value;
  if (!endereco.trim()) {
    alert('Digite um endere√ßo para buscar no mapa.');
    return;
  }
  
  // Mostrar o mapa
  document.getElementById('map').style.display = 'block';
  
  // Inicializar mapa se ainda n√£o foi criado
  if (!map) {
    // Coordenadas aproximadas de Ibi√∫na, SP
    map = L.map('map').setView([-23.6552, -47.2230], 13);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
  }
  
  // Buscar endere√ßo usando Nominatim (OpenStreetMap)
  const query = encodeURIComponent(endereco + ', Ibi√∫na, SP, Brasil');
  fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`)
    .then(response => response.json())
    .then(data => {
      if (data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        
        // Atualizar campos ocultos
        document.getElementById('id_latitude').value = lat;
        document.getElementById('id_longitude').value = lon;
        
        // Centralizar mapa e adicionar marcador
        map.setView([lat, lon], 16);
        
        if (marker) {
          map.removeLayer(marker);
        }
        
        marker = L.marker([lat, lon]).addTo(map)
          .bindPopup(`<strong>Local da Ocorr√™ncia</strong><br>${endereco}`)
          .openPopup();
          
        // Feedback visual
        this.textContent = '‚úì Localizado!';
        this.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        this.classList.add('bg-green-600', 'hover:bg-green-700');
        
        setTimeout(() => {
          this.textContent = 'Localizar no Mapa';
          this.classList.remove('bg-green-600', 'hover:bg-green-700');
          this.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      } else {
        alert('Endere√ßo n√£o encontrado. Tente ser mais espec√≠fico.');
      }
    })
    .catch(error => {
      console.error('Erro ao buscar endere√ßo:', error);
      alert('Erro ao buscar o endere√ßo. Tente novamente.');
    });
});

// M√°scara para telefone
document.getElementById('id_telefone_solicitante').addEventListener('input', function(e) {
  let value = e.target.value.replace(/\D/g, '');
  value = value.replace(/(\d{2})(\d)/, '($1) $2');
  value = value.replace(/(\d{5})(\d)/, '$1-$2');
  e.target.value = value;
});
</script>

<!-- Leaflet para mapas -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}