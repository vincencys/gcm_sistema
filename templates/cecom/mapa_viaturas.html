{% extends "_layout/base.html" %}
{% load static %}
{% block title %}Localização VTR's - CECOM{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-4">
  <div class="flex items-center justify-between">
    <h1 class="text-xl font-semibold">Localização VTR's</h1>
    <a href="{% url 'cecom:painel' %}" class="px-3 py-2 border rounded hover:bg-slate-50">Voltar</a>
  </div>

  <div class="bg-white border rounded p-3 flex items-center justify-between">
    <div class="text-sm text-slate-600">Mapa com as viaturas em plantão ativo. Atualiza a cada <span id="intervalo">8</span>s.</div>
    <div class="flex items-center gap-2 text-sm">
      <label>Intervalo:
        <select id="selIntervalo" class="border rounded px-2 py-1 text-sm">
          <option value="5000">5s</option>
          <option value="8000" selected>8s</option>
          <option value="12000">12s</option>
          <option value="20000">20s</option>
        </select>
      </label>
    </div>
  </div>

  <div id="map" style="height: 70vh;" class="w-full rounded border"></div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
let map, markers = {}, trilhas = {}, timerId = null, refreshMs = 8000, viaturaUsuarioId = null;

function initMap() {
  map = L.map('map');
  const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  });
  osm.addTo(map);
  // Centro inicial (Ibiúna approx)
  map.setView([-23.656, -47.223], 12);
}

function colorFor(id) {
  const palette = ['#2563eb','#16a34a','#dc2626','#7c3aed','#ea580c','#0891b2','#be185d','#065f46'];
  return palette[id % palette.length];
}

function buildIcon(isUser, color) {
  if(isUser) {
    const html = `<div class='relative -ml-3 -mt-3'>
        <div class="w-8 h-8 rounded-full border-2 border-emerald-500 bg-white flex items-center justify-center shadow">
          <div class='w-3 h-3 rounded-full bg-emerald-500 animate-ping'></div>
        </div>
      </div>`;
    return L.divIcon({className:'vtr-user-icon', html, iconSize:[16,16], iconAnchor:[0,0]});
  } else {
    const html = `<div class='w-4 h-4 -ml-2 -mt-2 rounded-full border border-white shadow' style='background:${color}'></div>`;
    return L.divIcon({className:'vtr-icon', html, iconSize:[8,8], iconAnchor:[0,0]});
  }
}

function upsertMarker(v) {
  const key = String(v.viatura_id);
  // Se não tem localização, colocamos fora da vista (ou poderíamos escolher centro + jitter leve)
  const hasLoc = v.tem_localizacao !== false && v.latitude != null && v.longitude != null;
  const latlng = hasLoc ? [v.latitude, v.longitude] : [0, 0];
  const label = `VTR ${v.prefixo}`;
  const isUser = (viaturaUsuarioId != null && v.viatura_id === viaturaUsuarioId);
  const content = `
    <div class=\"text-sm\">
      <div class=\"font-semibold\">${label}${isUser ? ' <span class=\"text-emerald-600\">(Você)</span>' : ''}</div>
      ${hasLoc ? `<div><b>Atualizado:</b> ${new Date(v.atualizado_em).toLocaleString()}</div>` : '<div class=\"text-rose-600\"><b>Sem sinal de localização</b></div>'}
      ${hasLoc && v.velocidade_kmh != null ? `<div><b>Vel.:</b> ${v.velocidade_kmh.toFixed(1)} km/h</div>` : ''}
      ${hasLoc && v.precisao_m != null ? `<div><b>Precisão:</b> ±${Math.round(v.precisao_m)} m</div>` : ''}
      ${Array.isArray(v.equipe) && v.equipe.length ? `<div class=\"mt-1\"><b>Equipe:</b> ${v.equipe.map(e=>e.matricula? `${e.matricula} - ${e.nome}` : e.nome).join(', ')}</div>` : ''}
    </div>`;
  if (!markers[key]) {
    const markerColor = hasLoc ? colorFor(v.viatura_id) : '#64748b'; // cinza para sem localização
    const m = L.marker(latlng, {title: label, icon: buildIcon(isUser, markerColor)});
    m.bindPopup(content);
    m.addTo(map);
    markers[key] = m;
  } else {
    markers[key].setLatLng(latlng);
    markers[key].setPopupContent(content);
    const markerColor = hasLoc ? colorFor(v.viatura_id) : '#64748b';
    markers[key].setIcon(buildIcon(isUser, markerColor));
  }
  if (Array.isArray(v.trilha) && v.trilha.length > 1) {
    if (!trilhas[key]) {
      trilhas[key] = L.polyline(v.trilha, {color: colorFor(v.viatura_id), weight: 4, opacity: 0.6}).addTo(map);
    } else {
      trilhas[key].setLatLngs(v.trilha);
    }
  } else if(trilhas[key]) {
    map.removeLayer(trilhas[key]); delete trilhas[key];
  }
}

function fitToMarkers() {
  const keys = Object.keys(markers);
  if (!keys.length) return;
  const group = L.featureGroup(keys.map(k => markers[k]));
  map.fitBounds(group.getBounds().pad(0.2));
}

async function fetchLocs() {
  try {
    const resp = await fetch('{% url "cecom:localizacoes_ativas" %}');
  const data = await resp.json();
  viaturaUsuarioId = data.viatura_usuario_id;
  const vs = data.viaturas || [];
    const seen = new Set();
    vs.forEach(v => { upsertMarker(v); seen.add(String(v.viatura_id)); });
    // Remove marcadores que não estão mais ativos
  Object.keys(markers).forEach(k => { if(!seen.has(k)) { map.removeLayer(markers[k]); delete markers[k]; } });
  Object.keys(trilhas).forEach(k => { if(!seen.has(k)) { map.removeLayer(trilhas[k]); delete trilhas[k]; } });
    fitToMarkers();
  } catch (e) {
    console.error('Erro ao buscar localizações', e);
  }
}

function schedule() {
  if (timerId) clearInterval(timerId);
  timerId = setInterval(fetchLocs, refreshMs);
  document.getElementById('intervalo').textContent = Math.round(refreshMs/1000);
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();
  fetchLocs();
  schedule();
  const sel = document.getElementById('selIntervalo');
  sel.addEventListener('change', () => { refreshMs = parseInt(sel.value, 10) || 8000; schedule(); });
});
</script>
{% endblock %}
