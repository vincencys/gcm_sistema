{% extends 'common/documentos_base.html' %}
{% block extra_nav %}
  <div class="mb-4 bg-white rounded-lg shadow-sm border border-slate-200 p-3">
    <div class="flex flex-wrap gap-2">
      
      <a href="{% url 'common:documentos_pendentes' %}" class="group relative inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 {% if request.resolver_match.url_name == 'documentos_pendentes' %}border-slate-500 bg-slate-50{% else %}border-slate-200 hover:border-slate-400 hover:bg-slate-50{% endif %} transition-all">
        <span class="text-xl">üìã</span>
        <span class="text-sm font-medium text-slate-700">Todos</span>
        <span class="flex items-center justify-center min-w-[20px] h-5 px-1.5 bg-slate-700 text-white text-xs font-bold rounded-full">{{ pend_counts.ronda|add:pend_counts.bogcm|add:pend_counts.livro }}</span>
      </a>

      <a href="{% url 'common:documentos_pendentes_ronda' %}" class="group relative inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 {% if request.resolver_match.url_name == 'documentos_pendentes_ronda' %}border-blue-500 bg-blue-50{% else %}border-blue-200 hover:border-blue-400 hover:bg-blue-50{% endif %} transition-all">
        <span class="text-xl">üìù</span>
        <span class="text-sm font-medium text-blue-700">Ronda</span>
        {% if pend_counts.ronda > 0 %}
          <span class="flex items-center justify-center min-w-[20px] h-5 px-1.5 bg-blue-600 text-white text-xs font-bold rounded-full">{{ pend_counts.ronda }}</span>
        {% endif %}
      </a>

      <a href="{% url 'common:documentos_pendentes_bogcm' %}" class="group relative inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 {% if request.resolver_match.url_name == 'documentos_pendentes_bogcm' %}border-green-500 bg-green-50{% else %}border-green-200 hover:border-green-400 hover:bg-green-50{% endif %} transition-all">
        <span class="text-xl">üì∞</span>
        <span class="text-sm font-medium text-green-700">BOGCM</span>
        {% if pend_counts.bogcm > 0 %}
          <span class="flex items-center justify-center min-w-[20px] h-5 px-1.5 bg-green-600 text-white text-xs font-bold rounded-full">{{ pend_counts.bogcm }}</span>
        {% endif %}
      </a>

      <a href="{% url 'common:documentos_pendentes_livro' %}" class="group relative inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 {% if request.resolver_match.url_name == 'documentos_pendentes_livro' %}border-indigo-500 bg-indigo-50{% else %}border-indigo-200 hover:border-indigo-400 hover:bg-indigo-50{% endif %} transition-all">
        <span class="text-xl">üìñ</span>
        <span class="text-sm font-medium text-indigo-700">Livro CECOM</span>
        {% if pend_counts.livro > 0 %}
          <span class="flex items-center justify-center min-w-[20px] h-5 px-1.5 bg-indigo-600 text-white text-xs font-bold rounded-full">{{ pend_counts.livro }}</span>
        {% endif %}
      </a>

    </div>
  </div>
{% endblock %}
{% block content %}
  {% with titulo='Despachos Pendentes - Todos' bulk_sign=True %}{{ block.super }}{% endwith %}

  <!-- Modal de Recusa com Observa√ß√£o (para BOGCMI) -->
  <div id="modal-recusa-bogcm" class="fixed inset-0 bg-black bg-opacity-50 hidden" style="z-index:2000;">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <h3 class="text-lg font-bold mb-2">Recusar BOGCM</h3>
        <p class="text-sm text-slate-600 mb-3">Informe o motivo (opcional) para devolver o BO ao encarregado.</p>
        <textarea id="modal-obs-text" rows="3" class="w-full border rounded px-3 py-2 mb-4" maxlength="255" placeholder="Motivo da recusa (opcional)"></textarea>
        <div class="flex gap-3 justify-end">
          <button type="button" onclick="fecharModalRecusa()" class="px-4 py-2 border rounded hover:bg-slate-50">Cancelar</button>
          <button type="button" onclick="confirmarRecusaModal()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Confirmar Recusa</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let recusaDocId = null;
    function abrirModalRecusa(id){
      recusaDocId = id;
      const el = document.getElementById('modal-recusa-bogcm');
      const txt = document.getElementById('modal-obs-text');
      if(el){
        if(txt) txt.value='';
        el.classList.remove('hidden');
        return;
      }
      // Fallback: se n√£o houver modal, usa prompt
      let obs = prompt('Informe o motivo da recusa (opcional):', '');
      if(obs === null){ return; }
      if(obs && obs.length>255) obs = obs.substring(0,255);
      const input = document.getElementById('obs-'+id);
      if(input){ input.value = obs || ''; }
      const form = document.getElementById('form-recusar-'+id);
      if(form){ form.submit(); }
    }
    function fecharModalRecusa(){
      recusaDocId = null;
      const el = document.getElementById('modal-recusa-bogcm');
      if(el) el.classList.add('hidden');
    }
    function confirmarRecusaModal(){
      if(!recusaDocId) return;
      const obs = (document.getElementById('modal-obs-text')?.value || '').trim();
      const input = document.getElementById('obs-'+recusaDocId);
      if(input){ input.value = (obs || '').substring(0,255); }
      const form = document.getElementById('form-recusar-'+recusaDocId);
      if(form){ form.submit(); }
      fecharModalRecusa();
    }
  </script>
{% endblock %}
{% block linha_acoes %}
  <div class="flex gap-2">
    <form method="post" action="{% url 'common:assinar_documento' d.id %}" onsubmit="return confirm('Assinar este documento?');">
      {% csrf_token %}
      <button class="bg-green-600 text-white px-3 py-1 rounded text-xs">Assinar</button>
    </form>
    {% if d.tipo == 'BOGCMI' %}
    <form method="post" id="form-recusar-{{ d.id }}" action="{% url 'common:recusar_documento' d.id %}">
      {% csrf_token %}
      <input type="hidden" name="observacao" id="obs-{{ d.id }}" />
      <button type="button" onclick="abrirModalRecusa({{ d.id }})" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Recusar</button>
    </form>
    {% endif %}
  </div>
{% endblock %}
{% block linha_acoes_mobile %}
  <div class="flex flex-wrap gap-2">
    <a href="{{ d.arquivo.url }}" target="_blank" class="inline-flex items-center justify-center px-3 py-1 border rounded bg-indigo-50 text-indigo-700 hover:bg-indigo-100 text-xs">Ver Doc</a>
    <form method="post" action="{% url 'common:assinar_documento' d.id %}" onsubmit="return confirm('Assinar este documento?');">
      {% csrf_token %}
      <button class="bg-green-600 text-white px-3 py-1 rounded text-xs">Assinar</button>
    </form>
    {% if d.tipo == 'BOGCMI' %}
    <form method="post" id="form-recusar-{{ d.id }}" action="{% url 'common:recusar_documento' d.id %}">
      {% csrf_token %}
      <input type="hidden" name="observacao" id="obs-{{ d.id }}" />
      <button type="button" onclick="abrirModalRecusa({{ d.id }})" class="bg-red-600 text-white px-3 py-1 rounded text-xs">Recusar</button>
    </form>
    {% endif %}
  </div>
{% endblock %}
